<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Crawler Monitor</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#047857',
                        danger: '#ef4444',
                        success: '#10b981'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="bg-white shadow-md rounded-lg p-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Web Crawler Monitoring System</h1>
                <p class="text-gray-600">Monitor your distributed web crawler and search indexed content</p>
            </div>
        </header>

        <!-- System Status -->
        <section class="mb-8">
            <div class="bg-white shadow-md rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">System Status</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 text-center">
                        <h3 class="text-blue-800 font-medium mb-2">URLs Queue</h3>
                        <div id="urls-queue" class="text-3xl font-bold text-blue-600">Loading...</div>
                    </div>
                    
                    <div class="bg-green-50 border border-green-100 rounded-lg p-4 text-center">
                        <h3 class="text-green-800 font-medium mb-2">Content Queue</h3>
                        <div id="content-queue" class="text-3xl font-bold text-green-600">Loading...</div>
                    </div>
                    
                    <div class="bg-purple-50 border border-purple-100 rounded-lg p-4 text-center">
                        <h3 class="text-purple-800 font-medium mb-2">S3 Storage</h3>
                        <div id="s3-status" class="text-3xl font-bold text-purple-600">Loading...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Add URLs -->
        <section class="mb-8">
            <div class="bg-white shadow-md rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Add URL to Crawl</h2>
                
                <form id="url-form" class="space-y-4">
                    <div class="flex flex-col md:flex-row gap-4">
                        <input 
                            type="url" 
                            id="url-input" 
                            placeholder="Enter URL to crawl (e.g. https://example.com)" 
                            required
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        >
                        <button 
                            type="submit"
                            class="px-6 py-2 bg-secondary text-white font-medium rounded-md hover:bg-green-700 transition duration-200 md:w-auto w-full"
                        >
                            Add URL
                        </button>
                    </div>
                </form>
                
                <div id="url-message" class="mt-4 text-sm"></div>
            </div>
        </section>

        <!-- Search -->
        <section class="mb-8">
            <div class="bg-white shadow-md rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Search Indexed Content</h2>
                <p class="text-gray-500 mb-4">Search results are fetched directly from the S3 bucket</p>
                
                <form id="search-form" class="space-y-4">
                    <div class="flex flex-col md:flex-row gap-4">
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="Enter search terms" 
                            required
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        >
                        <button 
                            type="submit"
                            class="px-6 py-2 bg-primary text-white font-medium rounded-md hover:bg-blue-700 transition duration-200 md:w-auto w-full"
                        >
                            Search
                        </button>
                    </div>
                </form>
                
                <div id="search-results" class="mt-6 space-y-2">
                    <!-- Results will be displayed here -->
                </div>
            </div>
        </section>
    </div>

    <!-- JavaScript -->
    <script>
        // Function to update system status
        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // Update URLs queue
                    const urlsQueueEl = document.getElementById('urls-queue');
                    urlsQueueEl.innerHTML = `
                        <div class="text-3xl font-bold text-blue-600">${data.urls_queue_size}</div>
                        <div class="text-sm text-blue-500">
                            <span title="Visible messages">${data.urls_queue_visible} visible</span> + 
                            <span title="In flight messages">${data.urls_queue_inflight} processing</span>
                        </div>
                    `;
                    
                    // Update content queue
                    const contentQueueEl = document.getElementById('content-queue');
                    contentQueueEl.innerHTML = `
                        <div class="text-3xl font-bold text-green-600">${data.content_queue_size}</div>
                        <div class="text-sm text-green-500">
                            <span title="Visible messages">${data.content_queue_visible} visible</span> + 
                            <span title="In flight messages">${data.content_queue_inflight} processing</span>
                        </div>
                    `;
                    
                    // Update S3 status
                    const s3StatusElement = document.getElementById('s3-status');
                    s3StatusElement.textContent = data.s3_status;
                    if (data.s3_status === 'available') {
                        s3StatusElement.classList.add('text-success');
                    } else {
                        s3StatusElement.classList.add('text-danger');
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        // Add URL form handling
        document.getElementById('url-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const url = document.getElementById('url-input').value;
            const messageElement = document.getElementById('url-message');
            
            fetch('/add-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `url=${encodeURIComponent(url)}`
            })
            .then(response => response.json())
            .then(data => {
                messageElement.textContent = data.message;
                messageElement.className = data.status === 'success' 
                    ? 'mt-4 text-sm text-success font-medium' 
                    : 'mt-4 text-sm text-danger font-medium';
                
                if (data.status === 'success') {
                    document.getElementById('url-input').value = '';
                    // Update status after adding URL - multiple times with delay
                    updateStatus(); // Immediate update
                    setTimeout(updateStatus, 1000); // 1 second later
                    setTimeout(updateStatus, 3000); // 3 seconds later
                }
            })
            .catch(error => {
                messageElement.textContent = 'Error adding URL: ' + error;
                messageElement.className = 'mt-4 text-sm text-danger font-medium';
            });
        });

        // Search form handling
        document.getElementById('search-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const query = document.getElementById('search-input').value;
            const resultsElement = document.getElementById('search-results');
            resultsElement.innerHTML = '<p class="text-gray-600">Searching S3 bucket...</p>';
            
            fetch(`/search?query=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Search results:", data); // Log the results for debugging
                    resultsElement.innerHTML = '';
                    
                    if (!data.results || data.results.length === 0) {
                        resultsElement.innerHTML = '<p class="text-gray-600">No results found</p>';
                    } else {
                        data.results.forEach(result => {
                            const div = document.createElement('div');
                            div.className = 'p-4 border border-gray-200 rounded-md hover:bg-gray-50 transition duration-100 mb-4';
                            
                            // Get URL and content from result
                            const url = result.url || 'No URL found';
                            const content = result.content || 'No content available';
                            const source = result.source || 'unknown';
                            
                            // Create HTML for the result
                            let resultHTML = '';
                            
                            // Handle S3 keys differently
                            if (typeof url === 'string' && url.startsWith('S3:')) {
                                resultHTML += `<div class="mb-2"><span class="text-purple-600 font-medium text-lg">${url}</span></div>`;
                            } else {
                                resultHTML += `<div class="mb-2"><a href="${url}" target="_blank" class="text-primary font-medium text-lg hover:underline">${url}</a></div>`;
                            }
                            
                            // Add content preview in a scrollable container
                            resultHTML += `
                                <div class="mt-2">
                                    <p class="text-xs text-gray-500 mb-1">Source: ${source}</p>
                                    <div class="bg-gray-50 p-3 rounded border border-gray-200 max-h-40 overflow-y-auto">
                                        <p class="text-sm text-gray-800 whitespace-pre-line">${content}</p>
                                    </div>
                                </div>
                            `;
                            
                            div.innerHTML = resultHTML;
                            resultsElement.appendChild(div);
                        });
                    }
                })
                .catch(error => {
                    console.error("Search error:", error);
                    resultsElement.innerHTML = `<p class="text-danger">Error performing search: ${error}</p>`;
                });
        });

        // Update status initially and every 3 seconds
        updateStatus();
        setInterval(updateStatus, 3000);
    </script>
</body>
</html> 